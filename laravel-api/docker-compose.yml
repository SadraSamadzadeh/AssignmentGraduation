version: "3.8"

services:
    # Laravel Application
    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: laravel-matching-api
        restart: unless-stopped
        working_dir: /var/www/html
        volumes:
            - ./:/var/www/html
            - ./storage/logs:/var/www/html/storage/logs
        environment:
            - APP_ENV=production
            - APP_DEBUG=false
            - DB_CONNECTION=pgsql
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_DATABASE=matching_db
            - DB_USERNAME=matching_user
            - DB_PASSWORD=matching_password
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
            - RABBITMQ_USER=admin
            - RABBITMQ_PASSWORD=admin
            - RABBITMQ_VHOST=/
            - QUEUE_CONNECTION=rabbitmq
        ports:
            - "8000:8000"
        depends_on:
            - postgres
            - rabbitmq
        networks:
            - matching-network

    # PostgreSQL Database
    postgres:
        image: postgres:15
        container_name: matching-postgres
        restart: unless-stopped
        environment:
            - POSTGRES_DB=matching_db
            - POSTGRES_USER=matching_user
            - POSTGRES_PASSWORD=matching_password
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./database/init:/docker-entrypoint-initdb.d
        ports:
            - "5432:5432"
        networks:
            - matching-network

    # RabbitMQ Message Broker
    rabbitmq:
        image: rabbitmq:3.12-management
        container_name: matching-rabbitmq
        restart: unless-stopped
        environment:
            - RABBITMQ_DEFAULT_USER=admin
            - RABBITMQ_DEFAULT_PASS=admin
            - RABBITMQ_DEFAULT_VHOST=/
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
            - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
        ports:
            - "5672:5672" # AMQP port
            - "15672:15672" # Management UI
        networks:
            - matching-network
        healthcheck:
            test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
            interval: 30s
            timeout: 10s
            retries: 5

    # Laravel Queue Worker
    queue-worker:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: laravel-queue-worker
        restart: unless-stopped
        working_dir: /var/www/html
        volumes:
            - ./:/var/www/html
        environment:
            - APP_ENV=production
            - DB_CONNECTION=pgsql
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_DATABASE=matching_db
            - DB_USERNAME=matching_user
            - DB_PASSWORD=matching_password
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
            - RABBITMQ_USER=admin
            - RABBITMQ_PASSWORD=admin
            - RABBITMQ_VHOST=/
            - QUEUE_CONNECTION=rabbitmq
        command: php artisan queue:work rabbitmq --sleep=3 --tries=3 --max-time=3600
        depends_on:
            - postgres
            - rabbitmq
        networks:
            - matching-network

    # Redis (optional - for caching and sessions)
    redis:
        image: redis:7-alpine
        container_name: matching-redis
        restart: unless-stopped
        volumes:
            - redis_data:/data
        ports:
            - "6379:6379"
        networks:
            - matching-network

# Named volumes for persistent data
volumes:
    postgres_data:
        driver: local
    rabbitmq_data:
        driver: local
    redis_data:
        driver: local

# Network for service communication
networks:
    matching-network:
        driver: bridge
